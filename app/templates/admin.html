{% extends "base.html" %}

{% block head_extra %}
<link href="{{ url_for('static', filename='css/admin.css') }}?v={{ config['ASSET_VERSION'] }}" rel="stylesheet">
{% endblock %}

{% set body_class = 'admin' %}
{% block content %}
<div class="container py-4 admin-dashboard">
  <div class="admin-hero-card">
    <div>
      <p class="eyebrow text-uppercase fw-semibold mb-1 text-primary">Aixtraball Cockpit</p>
      <h1 class="h3 mb-2">Inhalte pflegen</h1>
      <p class="text-muted mb-0">Wähle einen Bereich aus, bearbeite Texte mit dem integrierten Editor und veröffentliche Änderungen sofort.</p>
    </div>
    <div class="hero-actions">
      <button type="button" id="openGlobalPicker" class="btn btn-outline-primary">
        <i class="bi bi-images me-1"></i> Bilderbibliothek
      </button>
    </div>
  </div>

  <div class="admin-grid sections-grid single-column">
    {% for section in sections %}
    <article class="admin-card admin-card-section">
      <div class="section-icon rounded-circle">
        <i class="bi bi-{{ section.icon }}"></i>
      </div>
      <div class="section-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h5 mb-0">{{ section.title }}</h2>
          <span class="badge text-bg-light">{{ section.count }} {{ section.count == 1 and 'Eintrag' or 'Einträge' }}</span>
        </div>
        <p class="text-muted small mb-3">{{ section.description }}</p>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-primary" href="{{ url_for('admin_manage', filename=section.filename) }}">
            <i class="bi bi-list-task me-1"></i> Verwalten
          </a>
          {% if section.allow_new %}
          <a class="btn btn-outline-primary" href="{{ url_for('admin_item', filename=section.filename) }}">
            <i class="bi bi-plus-lg me-1"></i> Neuer Eintrag
          </a>
          {% else %}
          <span class="badge rounded-pill text-bg-secondary align-self-center">Nur Ansicht</span>
          {% endif %}
          <a class="btn btn-link text-muted" href="{{ url_for('admin_edit', filename=section.filename) }}">
            <i class="bi bi-code-slash me-1"></i> RAW
          </a>
        </div>
      </div>
    </article>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let imagesCache = null;
    const btn = document.getElementById('openGlobalPicker');
    if (!btn) return;
    const modalEl = document.getElementById('imagePickerModal');
    let bsModal = null;
    function ensureModal(){ if (bsModal) return bsModal; bsModal = new bootstrap.Modal(modalEl); return bsModal; }
    async function loadImages(){ if (imagesCache) return imagesCache; const r = await fetch('{{ url_for('admin_images') }}'); imagesCache = await r.json(); return imagesCache; }
    btn.addEventListener('click', async () => {
      const grid = document.getElementById('imageGrid');
      const search = document.getElementById('imageSearch');
      grid.innerHTML = '<div class="text-muted">Lade Bilder…</div>';
      const items = await loadImages();
      const render = (q='') => {
        const needle = q.trim().toLowerCase();
        const sel = items.filter(it => !needle || it.name.toLowerCase().includes(needle) || it.path.toLowerCase().includes(needle));
        grid.innerHTML = sel.map(it => `
          <div class="image-tile" data-path="${it.path}">
            <img src="${it.url}" alt="${it.name}">
            <div class="caption" title="${it.path}">${it.name}</div>
          </div>
        `).join('');
      };
      render('');
      search.value = '';
      search.oninput = () => render(search.value);
      grid.onclick = (e) => {
        const tile = e.target.closest('.image-tile');
        if (!tile) return;
        const path = tile.getAttribute('data-path');
        if (navigator.clipboard) navigator.clipboard.writeText(path).catch(()=>{});
        ensureModal().hide();
      };
      ensureModal().show();
    });
  });
</script>

<!-- Shared Image Picker Modal -->
<div class="modal fade" id="imagePickerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-images me-2"></i>Bild auswählen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="search" id="imageSearch" class="form-control" placeholder="Suchen…">
        </div>
        <div id="imageGrid" class="image-grid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
